<div id="post" class="mt-5 m-2">
  
  <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div class="toolbar mb-2 flex justify-between items-center">
    <div class="flex space-x-2">
      <button class="px-4 py-2 rounded-md" id="bold-button">
        <strong>B</strong>
      </button>
      <!--<button class="px-4 py-2 rounded-md" id="image-button">
        ğŸ–¼ï¸
      </button>-->
      <!-- ä»–ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒœã‚¿ãƒ³ã‚‚ã“ã“ã«è¿½åŠ å¯èƒ½ -->
    </div>
    <div class="text-sm text-gray-600" id="char-count">0 / 1000</div>
  </div>
  
  <!-- éè¡¨ç¤ºã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
  <input type="file" id="image-input" accept="image/*" style="display: none;" />
  
  <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
  <%= form_with(model: @micropost, url: zen_create_path(slug: @user.slug), method: :post, local: true, html: { class: "micropost-form" }) do |f| %>
    <!-- ç·¨é›†ã‚¨ãƒªã‚¢ -->
    <div class="field">
      <div
        id="editor"
        contenteditable="true"
        class="p-4 rounded border shadow-md hover:shadow-lg transition-shadow duration-300 w-full h-[400px]"
        data-placeholder="I have pen, I have an apple Uh! Apple-pen"
        style="min-height: 100px; overflow-y: auto;"
      >
        I have pen, I have an apple Uh! Apple-pen
      </div>
      <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’ä¿å­˜ï¼‰ -->
      <%= f.hidden_field :content, id: "hidden_content" %>
    </div>
  
    <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
    <div class="actions text-right mt-2">
      <button
        class="px-4 py-2 bg-gray-200 text-gray-500 border border-gray-300 
               rounded-md cursor-not-allowed
               disabled:hover:bg-gray-200 disabled:opacity-50"
        disabled
      >
        ğŸ¤–AI
      </button>
  
      <button class="hover:bg-yellow-500 px-4 py-2 bg-gray-100 border border-gray-300 text-gray-700 
                     hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 
                     focus:ring-gray-300 rounded-md">
        <%= link_to "ğŸ“¸ æ‰‹æ›¸ãã‚’èª­ã¿å–ã‚‹", camera_path(@user), class: "submit-button text-dark text-decoration-none" %>
      </button>
  
      <%= f.submit "ğŸ“ ä¸‹æ›¸ãä¿å­˜", name:"draft", class: "hover:bg-yellow-500 px-4 py-2 bg-gray-200 border border-gray-300 text-gray-800 
                 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 
                 focus:ring-gray-400 rounded-md" %>
  
      <%= f.submit "post", class: "hover:bg-yellow-500 px-4 py-2 bg-gray-200 border border-gray-300 text-gray-800 
                 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 
                 focus:ring-gray-400 rounded-md" %>
    </div>
  <% end %>
  
  <!-- ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”¨ã®CSS -->
  <style>
    [data-placeholder]:empty::before {
      content: attr(data-placeholder);
      color: #aaa;
      pointer-events: none;
    }
  </style>
  
</div><!--post-->


<script>
  document.addEventListener('DOMContentLoaded', function() {
    const boldButton = document.getElementById('bold-button');
    const imageButton = document.getElementById('image-button');
    const imageInput = document.getElementById('image-input');
    const editor = document.getElementById('editor');
    const hiddenContent = document.getElementById('hidden_content');
    const form = editor.closest('form');
    const charCount = document.getElementById('char-count');
    const MAX_CHARS = 1000;

    // ç·¨é›†ã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åŒæœŸ
    function syncContent() {
      hiddenContent.value = editor.innerHTML;
    }

    // æ–‡å­—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦è¡¨ç¤º
    function updateCharCount() {
      // innerText ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ–‡å­—æ•°ã‚’å–å¾—
      let text = editor.innerText || "";
      let currentCount = text.length;
      
      // 1000æ–‡å­—ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã®å‡¦ç†
      if (currentCount > MAX_CHARS) {
        charCount.textContent = `${MAX_CHARS} / ${MAX_CHARS}`;
        charCount.classList.add('text-red-500');
        // è¶…ãˆãŸå ´åˆã¯è¿½åŠ ã®æ–‡å­—ã‚’å‰Šé™¤ã™ã‚‹
        // ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ1000æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã§ããªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
        // ãŸã ã—ã€HTMLã‚¿ã‚°ã‚’å«ã‚€å ´åˆã¯é©åˆ‡ãªå‡¦ç†ãŒå¿…è¦ã§ã™ã€‚
        editor.innerText = text.substring(0, MAX_CHARS);
        currentCount = MAX_CHARS;
      } else {
        charCount.textContent = `${currentCount} / ${MAX_CHARS}`;
        charCount.classList.remove('text-red-500');
      }
    }

    // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    boldButton.addEventListener('click', function(event) {
      event.preventDefault();
      document.execCommand('bold', false, null);
      syncContent();
      updateCharCount();
    });

    // ç”»åƒæŒ¿å…¥ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    imageButton.addEventListener('click', function(event) {
      event.preventDefault();
      imageInput.click();
    });

    // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã¨ãã®å‡¦ç†
    imageInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = 'Inserted Image';
          img.style.maxWidth = '100%'; // ç”»åƒãŒã‚¨ãƒ‡ã‚£ã‚¿ã®å¹…ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
          img.style.height = 'auto';
          insertImage(img);
          syncContent();
          updateCharCount();
        }
        reader.readAsDataURL(file);
      }
      // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
      imageInput.value = '';
    });

    // ç”»åƒã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã«æŒ¿å…¥ã™ã‚‹é–¢æ•°
    function insertImage(img) {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      const range = selection.getRangeAt(0);
      range.collapse(false); // ã‚«ãƒ¼ã‚½ãƒ«ã‚’é¸æŠç¯„å›²ã®å¾Œã‚ã«ç§»å‹•

      range.insertNode(img);

      // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç”»åƒã®å¾Œã‚ã«ç§»å‹•
      range.setStartAfter(img);
      range.collapse(true);
      selection.removeAllRanges();
      selection.addRange(range);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«å†…å®¹ã‚’åŒæœŸ
    form.addEventListener('submit', function() {
      syncContent();
    });

    // ç·¨é›†ã‚¨ãƒªã‚¢ã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã«ã‚‚åŒæœŸï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
    editor.addEventListener('input', function() {
      syncContent();
      updateCharCount();
    });

    // åˆæœŸæ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã®æ›´æ–°
    updateCharCount();
  });
</script>
